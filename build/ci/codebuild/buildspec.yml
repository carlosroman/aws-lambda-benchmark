---
version: 0.2

env:
  variables:
    S3_BUCKET: "cliche-cloud-sam-test"
    GO111MODULE: on
    LOCAL_M2: ${HOME}/.m2

phases:

  install:
    commands:
      # Print all environment variables (handy for AWS CodeBuild logs)
      - make info

      # Start Docker
      - chmod +x build/builder/dockerd-start.sh
      - ./build/builder/dockerd-start.sh

  pre_build:
    commands:
      # Check Docker running
      - docker run --rm hello-world
      - docker-compose version
      # Check AWS CLI version
      - aws --version
      # Check  AWS SAM version
      - sam --version
      # Pull latest Lambda Docker images and start API
#      - make sam-pull sam-start DETACH_ENABLED=true

  build:
    commands:
      # Check SAM template correct
      - make sam-lint
      # Fetch all dependencies
      - make build-golang
      # Run BDD tests
      - mkdir -p ${LOCAL_M2}
      - make sam-test

  post_build:
    commands:
      # Package our application with AWS SAM
      - aws cloudformation package --template-file "${CODEBUILD_SRC_DIR}/api/aws-sam/template.yaml" --s3-bucket ${S3_BUCKET} --output-template-file packaged.yml

artifacts:
  files:
    - packaged.yml
